<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login - GoldMex</title>
  <link rel="icon" href="assets/favicon.png" type="image/png">
  <link rel="stylesheet" href="css/login-style.css" />
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
</head>

<body class="login-page">

  <ul class="animated-bg-flow">
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
  </ul>

  <div class="login-wrapper">
    <img src="assets/logo.png" alt="GoldMex Logo" class="login-logo"
      onerror="this.onerror=null; this.src='https://placehold.co/120x50/1a365d/d4af37?text=GoldMex+Logo&font=montserrat';" />
    <h2>GoldMex System</h2>

    <div id="g_id_onload" data-client_id="686783851365-nip1ufvpr15293d39ifisvs4q9182ab1.apps.googleusercontent.com"
      data-callback="handleCredentialResponse" data-auto_prompt="false">
    </div>
    <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with"
      data-shape="rectangular" data-logo_alignment="left">
    </div>

    <div class="login-separator"><span>or</span></div>

    <button id="microsoft-signin-btn" class="microsoft-btn">
      <i class='bx bxl-microsoft' style="color: #0078D4;"></i> <span>Sign in with Microsoft</span>
    </button>

    <div id="login-error-message"
      style="color: var(--goldmex-accent, #e31837); margin-top: 15px; font-size: 0.9rem; display: none;"></div>
  </div>

  <script>
    // Supabase Configuration
    const SUPABASE_URL = "https://ogatafslnevidfopuvbp.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nYXRhZnNsbmV2aWRmb3B1dmJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NDM0MTQsImV4cCI6MjA2MjMxOTQxNH0.Z4uAWCmyzbiFBVM51vLHwo7larVx6Y3wYK6vMzgj9j0";
    let supabase;

    try {
      if (window.supabase && typeof window.supabase.createClient === "function") {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log("Supabase client initialized in login page.");
      } else {
        console.error("Supabase library not loaded or createClient is not a function.");
        displayLoginError("Initialization error. Please refresh the page.");
      }
    } catch (error) {
      console.error("Error initializing Supabase in login.html:", error);
      displayLoginError("Could not initialize data service. Please refresh.");
    }

    // --- User Access Configuration ---
    // This pre-check configuration MUST be kept in sync with script.js

    // Role 1: Managers (Total Access)
    const MANAGER_USERS = [
      "fulfillment@gmxecommerce.com",
      "tgarcia@goldmexintl.com",
      "kmartinez@goldmexintl.com",
      "goldmexgmx@hotmail.com"
    ];

    // Role 2: Employees (Standard Access)
    const EMPLOYEE_DOMAINS = ["@gmxecommerce.com", "@goldmexintl.com"];
    const EMPLOYEE_EXCEPTIONS = ["kikecanfir@gmail.com", "enriqueflores.10@hotmail.com"];

    // Role 3: Clients / Restricted (Limited Access)
    const RESTRICTED_VIEW_DOMAINS = ["@estafeta.com"];
    const RESTRICTED_VIEW_USERS = [
        "kikecanfir5@gmail.com",
        ""
    ];

    function isUserAllowed(email) {
      if (!email) return false;
      const lowerEmail = email.toLowerCase();
      const domain = lowerEmail.substring(lowerEmail.lastIndexOf("@"));

      // Check if user exists in any of the defined roles
      if (
        MANAGER_USERS.includes(lowerEmail) ||
        EMPLOYEE_DOMAINS.includes(domain) ||
        EMPLOYEE_EXCEPTIONS.includes(lowerEmail) ||
        RESTRICTED_VIEW_DOMAINS.includes(domain) ||
        RESTRICTED_VIEW_USERS.includes(lowerEmail)
      ) {
        return true;
      }

      console.warn(`Email ${lowerEmail} (domain: ${domain}) is not allowed for Goldmex System.`);
      return false;
    }

    function displayLoginError(message) {
      const errorMessageElement = document.getElementById('login-error-message');
      if (errorMessageElement) {
        errorMessageElement.textContent = message;
        errorMessageElement.style.display = 'block';
      } else {
        alert(message); // Fallback if the element does not exist
      }
    }

    // Function to handle Google credential response
    async function handleCredentialResponse(response) {
      if (!supabase) {
        displayLoginError("Supabase client is not initialized. Cannot sign in.");
        console.error("Supabase client missing in handleCredentialResponse.");
        return;
      }
      if (!response.credential) {
        displayLoginError("Invalid response from Google. Please try again.");
        console.error("Google credential response is invalid:", response);
        return;
      }

      let googleUserEmail;
      try {
        const decodedToken = jwt_decode(response.credential);
        googleUserEmail = decodedToken.email;
      } catch (e) {
        console.error("Error decoding Google token:", e);
        displayLoginError("Error processing Google information. Please try again.");
        return;
      }

      // Check if the user's email is allowed before proceeding
      if (!isUserAllowed(googleUserEmail)) {
        displayLoginError("Access denied. Please use a valid corporate email account or contact the administrator.");
        console.error("Login attempt from unauthorized domain/email:", googleUserEmail);
        return;
      }

      document.getElementById('login-error-message').style.display = 'none'; // Hide previous errors

      try {
        console.log("Attempting Supabase sign-in with Google ID Token for:", googleUserEmail);
        const { data, error: supabaseError } = await supabase.auth.signInWithIdToken({
          provider: 'google',
          token: response.credential,
        });

        if (supabaseError) {
          console.error("Supabase signInWithIdToken error:", supabaseError);
          displayLoginError(`Authentication error: ${supabaseError.message}. Please try again.`);
          return;
        }

        console.log("Supabase session established:", data);
        window.location.href = 'index.html'; // Redirect to the main page

      } catch (e) {
        console.error("Error during Supabase sign-in process:", e);
        displayLoginError("An unexpected error occurred during sign-in.");
      }
    }

    // Function to handle Microsoft sign-in
    async function signInWithMicrosoft() {
      if (!supabase) {
        displayLoginError("Supabase client is not initialized. Cannot sign in.");
        console.error("Supabase client missing in signInWithMicrosoft.");
        return;
      }

      document.getElementById('login-error-message').style.display = 'none'; // Hide previous errors

      console.log("Attempting Supabase sign-in with Microsoft (Azure) provider.");
      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: 'azure',
        options: {
          scopes: 'email'
        }
      });

      if (error) {
        console.error("Supabase signInWithOAuth (Azure) error:", error);
        displayLoginError(`Authentication error: ${error.message}. Please try again.`);
      }
      // Note: After this call, Supabase handles the redirect to Microsoft, 
      // and then back to the app. The onAuthStateChange listener in script.js will handle the login.
    }

    // Check if the user is already logged in when the login page loads
    async function checkInitialSession() {
      if (!supabase) return;
      const { data: { session } } = await supabase.auth.getSession();
      if (session && session.user && isUserAllowed(session.user.email)) {
        console.log("User already logged in and allowed, redirecting from login.html to index.html");
        window.location.href = 'index.html';
      } else if (session && session.user && !isUserAllowed(session.user.email)) {
        console.warn(`User ${session.user.email} logged in but not allowed. Forcing Supabase sign out.`);
        await supabase.auth.signOut();
        displayLoginError("Your account does not have permission to access. You have been logged out.");
      }
    }

    if (supabase) {
      checkInitialSession();
    } else {
      const ensureSupabaseLoaded = setInterval(() => {
        if (window.supabase && !supabase) {
          try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log("Supabase client re-initialized successfully.");
            checkInitialSession();
            clearInterval(ensureSupabaseLoaded);
          } catch (e) {
            console.error("Failed to re-initialize Supabase:", e);
            clearInterval(ensureSupabaseLoaded);
          }
        } else if (supabase) {
          clearInterval(ensureSupabaseLoaded);
        }
      }, 500);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const microsoftButton = document.getElementById('microsoft-signin-btn');
      if (microsoftButton) {
        microsoftButton.addEventListener('click', signInWithMicrosoft);
      }
    });

  </script>
</body>

</html>
